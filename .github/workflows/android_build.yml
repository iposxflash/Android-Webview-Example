name: Dynamic WebAPK Generator

on:
  # Pemicu yang menerima input dari website (melalui backend/API)
  workflow_dispatch:
    inputs:
      URL:
        description: 'URL Website Utama'
        required: true
        default: 'https://default.com'
      PACKAGE_NAME:
        description: 'Package Name Aplikasi'
        required: true
        default: 'com.default.app'
      ICON_BASE64:
        description: 'Icon Aplikasi (Base64 String)'
        required: true
      KEY_ALIAS:
        description: 'Alias Keystore'
        required: true
      KEY_PASS:
        description: 'Password Kunci'
        required: true
      STORE_PASS:
        description: 'Password Store'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    # üõ†Ô∏è FIX 1: Dinamis Mengganti Package Name, URL, dan Permissions
    - name: Update Configs and Permissions
      run: |
        # 1. Ganti Application ID di build.gradle
        # Mengganti baris 'applicationId "com.tufanakcay.androidwebview"' dengan input dinamis
        sed -i 's/applicationId ".*"/applicationId "${{ github.event.inputs.PACKAGE_NAME }}"/g' app/build.gradle
        
        # 2. Ganti URL di strings.xml (asumsi ada string bernama 'web_url')
        # Jika Anda menyimpan URL di MainActivity.java, ganti script sed ini.
        sed -i 's|<string name="web_url">.*</string>|<string name="web_url">${{ github.event.inputs.URL }}</string>|g' app/src/main/res/values/strings.xml
        
        # 3. FIX: Tambahkan izin eksekusi gradlew
        chmod +x gradlew
        
    # üõ†Ô∏è FIX 2: Dekode Icon Base64 dan Simpan ke Folder Resource
    - name: Decode Base64 Icon and Save
      run: |
        # Membuat folder jika belum ada (sesuai standar Android)
        mkdir -p app/src/main/res/mipmap-xxhdpi/
        # Dekode string Base64 yang panjang ke file PNG
        echo "${{ github.event.inputs.ICON_BASE64 }}" | base64 --decode > app/src/main/res/mipmap-xxhdpi/ic_launcher.png

    # üõ†Ô∏è FIX 3: Generate Dynamic Keystore
    - name: Generate Dynamic Keystore
      # Menggunakan input YML sebagai password keystore
      run: |
        keytool -genkey -v -keystore release-key.jks \
        -alias ${{ github.event.inputs.KEY_ALIAS }} \
        -keyalg RSA -keysize 2048 -validity 10000 \
        -storepass ${{ github.event.inputs.STORE_PASS }} \
        -keypass ${{ github.event.inputs.KEY_PASS }} \
        -dname "CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, S=Unknown, C=Unknown"
      
    - name: Clean and Build APK and AAB (Release Signed)
      # Menjalankan assembleRelease (APK) DAN bundleRelease (AAB)
      run: ./gradlew clean assembleRelease bundleRelease --no-daemon 

    # 5. Upload APK Artifact
    - name: Upload Release APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release-signed-apk
        path: app/build/outputs/apk/release/app-release.apk

    # 6. Upload AAB Artifact
    - name: Upload Release AAB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release-signed-aab
        path: app/build/outputs/bundle/release/app-release.aab
