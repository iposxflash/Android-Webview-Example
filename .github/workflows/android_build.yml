name: Dynamic WebAPK Generator

on:
  workflow_dispatch:
    inputs:
      URL:
        description: 'URL Website Utama'
        required: true
        default: 'https://default.com'
      PACKAGE_NAME:
        description: 'Package Name Aplikasi'
        required: true
        default: 'com.default.app'
      ICON_URL: 
        description: 'URL Icon Aplikasi (PNG/JPG, Max 5MB)'
        required: true
      KEY_ALIAS:
        description: 'Alias Keystore'
        required: true
        default: 'mykey'
      KEY_PASS:
        description: 'Password Kunci'
        required: true
        default: 'android'
      STORE_PASS:
        description: 'Password Store'
        required: true
        default: 'android'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Ensure gradlew is executable
      run: chmod +x gradlew
        
    - name: Update Configs (Package Name dan URL)
      run: |
        # 1. Update Package Name di app/build.gradle
        # Menggunakan sed yang ketat untuk mengganti applicationId
        sed -i "s/^\(applicationId \s*\).*/\1\"${{ github.event.inputs.PACKAGE_NAME }}\"/g" app/build.gradle
        
        # 2. Update URL di app/src/main/res/values/strings.xml
        # Mengganti placeholder web_url
        sed -i "s|<string name=\"web_url\">.*</string>|<string name=\"web_url\">${{ github.event.inputs.URL }}</string>|g" app/src/main/res/values/strings.xml
        
    # Membuat file properties signing untuk Gradle (release.properties) di ROOT
    - name: Create Signing Properties File
      run: |
        echo "storeFile=release-key.jks" > release.properties
        echo "keyAlias=${{ github.event.inputs.KEY_ALIAS }}" >> release.properties
        echo "keyPassword=${{ github.event.inputs.KEY_PASS }}" >> release.properties
        echo "storePassword=${{ github.event.inputs.STORE_PASS }}" >> release.properties
        
    - name: Remove Existing Icons
      run: |
        rm -f app/src/main/res/mipmap-xxhdpi/*

    # Langkah download ikon dari URL
    - name: Download Icon from URL and Save
      run: |
        ICON_DIR="app/src/main/res/mipmap-xxhdpi/"
        mkdir -p $ICON_DIR
        # Mengunduh file dari URL ke nama yang sesuai (ic_launcher.png)
        curl -L "${{ github.event.inputs.ICON_URL }}" -o $ICON_DIR/ic_launcher.png

    # Keystore dibuat di dalam FOLDER 'app/'
    - name: Generate Dynamic Keystore
      run: |
        keytool -genkey -v -keystore app/release-key.jks \
        -alias ${{ github.event.inputs.KEY_ALIAS }} \
        -keyalg RSA -keysize 2048 -validity 10000 \
        -storepass ${{ github.event.inputs.STORE_PASS }} \
        -keypass ${{ github.event.inputs.KEY_PASS }} \
        -dname "CN=Dynamic Key, OU=Webview, O=PWA, L=Jakarta, S=ID, C=ID"
      
    # Memberi izin akses penuh pada file Keystore di FOLDER 'app/'
    - name: Change Keystore Permissions
      run: chmod 777 app/release-key.jks
      
    - name: Clean and Build APK and AAB (Release Signed)
      run: ./gradlew clean assembleRelease bundleRelease --no-daemon 
      
    # Upload Keystore dari lokasi baru (app/)
    - name: Upload Dynamic Keystore Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-keystore
        path: app/release-key.jks
        
    - name: Upload Release APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release-signed-apk
        path: app/build/outputs/apk/release/app-release.apk

    - name: Upload Release AAB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release-signed-aab
        path: app/build/outputs/bundle/release/app-release.aab
